## Betaflight 3.5.8 with Сrash Level Recovery for Tiny Whoops

Betaflight 3.5.8 сделан на основе Betaflight 3.5.7 с добавлением функции **Level Recovery** специально для вупов.

**Level Recovery** устраняет сбой гироскопа, при котором после сильных столкновений на вупе сбивается горизонт, и его начинает тянуть в сторону в течение нескольких секунд.

По крайней мере, пытается устранить. :)

### Теория

В Бетафлайте ориентация дрона относительно горизонта определяется фильтром Махони. Фильтр принимает на входе показания гироскопа и акселерометра, смешивает их хитрым образом через матрицы, кватернионы и прочую мудрёную математику и получает на выходе ориентацию относительно земли. Работает этот фильтр только в режимах Angle/Horizon, в режиме Acro он не принимает участия. Потому заметить проблему можно только на вупах, летающих в стабе. Реализован фильтр Махони [здесь](https://github.com/betaflight/betaflight/blob/master/src/main/flight/imu.c) в функции `imuMahonyAHRSupdate()`

Во время сильного удара дрон крутится со скоростью большей, чем может зарегистрировать гироскоп (2000°/сек). На фильтр приходят некорректные значения скорости, и положение определяется неправильно. Фильтр Махони очень инерционный и на восстановление может уйти 10-15 секунд. В это время пилот наблюдает, как его вуп тянет в сторону. Имеющиеся в Бетафлайте функции `crash_recovery` в режимах Angle/Horizon не помогают. Спасает только посадка и дизарм, при котором происходит сброс значений в фильтре.
Тут в [issue #5325](https://github.com/betaflight/betaflight/issues/5325) обсуждалась проблема и в результате разработчики пришли к решению с дизармом/армом.

Проблема исключительно софтовая. При "пьяном" полёте с гиры и с акселя идут правильные показания, просто фильтр их неверно совмещает и неверно считает горизонт. Происходит это потому, что он "помнит" момент удара, когда были зашкаливающие за 2000°/сек показания, и летит криво до тех пор, пока не "забудет" их.

Моя небольшая модификация BF детектирует столкновения и в течение двух секунд после удара в несколько раз ускоряет стабилизацию работы фильтра, а именно увеличивает коэффициент `dcm_Kp`, отвечающий за скорость сходимости показаний гироскопа и акселерометра.

[Видео, демонстрирующее срабатывание Level Recovery](https://youtu.be/Ftog5Rmj9hc).

После удара активируется восстановление горизонта и на OSD появляется надпись "RECOVERY". В течение этого времени гироскоп и акселерометр приходят в себя. Полёт продолжается без уплывшего горизонта.


### Что нужно сделать

1. Прошить HEX-файл со сборкой Betaflight 3.5.8 со страницы [Releases](https://github.com/alexeystn/betaflight/releases).
2. Восстановить в конфигураторе свои привычные настройки, которые вы используете в 3.5.7.
3. Убедиться что на OSD включены Warnings.
4. Проверить поведение вупа при сильных крашах.
5. Сообщить [мне](https://t.me/AlexeyStn) о результате: 
- стало лучше (перестал сбиваться горизонт)
- стало хуже (уплывает даже там, где раньше не уплывало) 
- ничего не изменилось


Функцию можно включать и отключать в консоли:
`set level_recovery = ON`
(или `OFF`, по умолчанию стоит `ON`) При значении `OFF` вуп ведёт себя точно так же, как и на стоковой 3.5.7. 


### CLI параметры

В прошивку добавлено несколько консольных параметров.

Переменная|Описание|Default 
----------|--------|-------
`level_recovery`|Включение/отключение функции.|ON
`level_recovery_time`| Время работы ускоренной стабилизации после удара, в миллиcекундах.|2500
`level_recovery_coef`|Множитель, показывающий, во сколько раз ускоряется фильтр после краша.|5
`level_recovery_threshold`|Порог срабатывания функции в градусах в секунду.|1900
`osd_warn_level_recovery`|Включает отображение надписи "RECOVERY" на OSD.|ON
  

Прошивка собрана под наиболее популярные полётные контроллеры для микро-квадриков. 
Если вашего таргета нет в списке, напишите мне в телеграм https://t.me/AlexeyStn и я добавлю его.

Версия 3.5.7 выбрана потому, что она полноценно поддерживается полётными контроллерами с F3, а так же потому, что далеко не всем пилотам удалось хорошо настроить Betaflight 4 на своих вупах.
