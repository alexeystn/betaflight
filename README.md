## Betaflight 3.5.8 with Сrash Level Recovery for Tiny Whoops

Betaflight 3.5.8 сделан на основе Betaflight 3.5.7 с добавлением функции **Level Recovery**.

Level Recovery устраняет сбой гироскопа, при котором после сильных столкновений на вупе сбивается горизонт, и его начинает тянуть в сторону в течение нескольких секунд.

По крайней мере, пытается устранить. :)

### Теория

В Бетафлайте ориентация дрона относительно горизонта определяется фильтром Махони. Фильтр принимает на входе показания гироскопа и акселерометра, смешивает их хитрым образом через матрицы, кватернионы и прочую мудрёную математику и получает на выходе ориентацию относительно земли. Работает этот фильтр только в режимах Angle/Horizon, в режиме Acro он не принимает участия. Потому заметить проблему можно только на вупах, на 5-дюймовые дроны она не влияет.

Реализован фильтр Махони здесь:
https://github.com/betaflight/betaflight/blob/master/src/main/flight/imu.c в функции imuMahonyAHRSupdate()

### Проблема

Во время сильного удара дрон крутится со скоростью большей, чем может зарегистрировать гироскоп (2000 градусов в секунду). На фильтр приходят некорректные значения скорости и положение определяется неправильно. Фильтр Махони очень инерционный и на восстановление может уйти 10-15 секунд. В это время пилот наблюдает, как его вуп тянет в сторону.

Имеющиеся в Бетафлайте функции `crash_recovery` в режимах Angle/Horizon не помогают. Спасает только посадка и дизарм, при котором происходит сброс значений в фильтре.

### Решение

Моя небольшая модификация BF детектирует столкновения и в течение двух секунд после удара в несколько раз ускоряет стабилизацию работы фильтра, а именно увеличивает коэффициент `dcm_Kp`, отвечающий за скорость сходимости показаний гироскопа и акселерометра.

Видео, демонстрирующее срабатывание Level Recovery:
https://youtu.be/Ftog5Rmj9hc

После сильного удара активируется восстановление горизонта и на OSD появляется надпись "RECOVERY". В течение этого времени гироскоп и акселерометр приходят в себя. Полёт продолжается без уплывшего горизонта.


### Что нужно сделать

1. Прошить HEX-файл со сборкой Betaflight 3.5.8.
2. Восстановить в конфигураторе свои привычные настройки, которые вы используете в 3.5.7.
3. Убедиться что на OSD включены Warnings.
4. Проверить поведение вупа при сильных крашах.
5. Сообщить мне о результате: 
- стало лучше (перестал сбиваться горизонт)
- стало хуже (уплывает даже там, где раньше не уплывало) 
- ничего не изменилось


Можно включать и отключать эту функцию в консоли:

`set level_recovery = ON` (или `OFF`, по умолчанию стоит `ON`)

При значении `OFF` вуп ведёт себя точно так же, как и на стоковой 3.5.7. 


### Что ещё можно сделать

Прописать в консоли: 
```
   set debug_mode = RECOVERY
   save
```
В конфигураторе вывести на OSD параметр `Debug`, а также `Angle:Pitch` и `Angle:Roll`.
После этого попробовать полетать с крашами, записать DVR с процессом и поделиться со мной.
Цифры на OSD помогут мне для дальнейшей работы.


### CLI параметры

В прошивку добавлено несколько консольных параметров. Их можно изменять в CLI:

Переменная|Описание|Default 
----------|--------|-------
`level_recovery`|Включение/отключение функции.|ON
`level_recovery_time`| Время работы ускоренной стабилизации после удара, в миллиcекундах.|2500
`level_recovery_coef`|Множитель, показывающий, во сколько раз ускоряется фильтр после краша.|5
`level_recovery_threshold`|Порог срабатывания функции в градусах в секунду.|1900
`osd_warn_level_recovery`|Включает отображение надписи "RECOVERY" на OSD.|ON
  

Прошивка собрана под наиболее популярные полётные контроллеры для микро-квадриков. 

HEX-файлы находятся на странице Releases:https://github.com/alexeystn/betaflight/releases

Если вашего таргета нет в списке, напишите мне в телеграм t.me/AlexeyStn и я добавлю его.
