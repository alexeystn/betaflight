# Betaflight 4.3.0-STN

This is Betaflight 4.3 fork by AlexeyStn with three major features:

* IMU level recovery
* Heart rate OSD element
* Unique ID label on OSD

_TODO: English description_

## IMU level recovery

Устраняет последствия очень сильных столкновений в режимах Angle/Horizon. Актуально для тинивупов.

Детектирует удар и на нескольких секунд изменяет работу фильтра акселерометра, позволяя скомпенсировать сбившийся горизонт. На OSD в это время выводится сообщение `RECOVERY`. 

<details>
  <summary> [Теория] </summary>
<br>

В Betaflight ориентация дрона относительно горизонта определяется фильтром Махони. Фильтр принимает на входе показания гироскопа и акселерометра, смешивает их хитрым образом через матрицы, кватернионы и другую сложную математику и получает на выходе ориентацию относительно земли. Работает этот фильтр только в режимах Angle/Horizon, в режимах Acro/Air он не принимает участия. Потому заметить проблему можно только на вупах, летающих в стабе. Реализован фильтр Махони [здесь](https://github.com/betaflight/betaflight/blob/master/src/main/flight/imu.c) в функции `imuMahonyAHRSupdate()`.

Во время сильного удара дрон крутится со скоростью большей, чем может зарегистрировать гироскоп (2000°/сек). На фильтр приходят некорректные значения скорости вращения, и положение вычисляется неправильно. Фильтр Махони весьма инерционный, и на восстановление может уйти до 20 секунд. В это время пилот наблюдает, как его вуп тянет в сторону. 

Имеющиеся в Betaflight функции `crash_recovery` в режимах Angle/Horizon не помогают. Спасает только посадка и дизарм, при котором происходит сброс фильтра. Тут в [issue #5325](https://github.com/betaflight/betaflight/issues/5325) обсуждалась проблема, и в результате разработчики пришли к компромиссному решению с дизармом/армом.

Данная модификация BF детектирует столкновения и в течение 2.5 секунд после удара в 5 раз ускоряет стабилизацию фильтра, а именно увеличивает коэффициент `dcm_Kp`, отвечающий за скорость сходимости показаний гироскопа и акселерометра.

</details>

[Видео, демонстрирующее срабатывание Level Recovery](https://youtu.be/Ftog5Rmj9hc).

[И ещё одно видео от XF0L](https://www.youtube.com/watch?v=3IZF_kBiFEQ).

Параметр|Описание|Default 
----------|--------|-------
`level_recovery`|Включение/отключение функции|OFF
`level_recovery_delay`| Задержка после удара, в миллиcекундах|500
`level_recovery_time`| Время работы ускоренной стабилизации после удара, в миллиcекундах|2500
`level_recovery_coef`|Множитель, показывающий, во сколько раз ускоряется фильтр после краша|5
`level_recovery_threshold`|Порог срабатывания функции в градусах в секунду|1950
`osd_warn_level_recovery`|Включает отображение надписи "RECOVERY" на OSD.|ON

Для включения необходимо ввести в CLI:
```
set level_recovery = ON
save
```
Остальные параметры по умолчанию подходят для большинства случаев.

## Heart rate OSD element

Отображение частоты пульса пилота на OSD.

Требуется: 

* Плата ESP32, подключенная к аппаратуре управления 
* Bluetooth-пульсометр

Подробное описание проекта здесь: https://github.com/alexeystn/heart-rate-fpv

## OSD unique ID label

Функция для пилотов, имеющих несколько идентичных дронов с одинаковыми настройками, 
желающих автоматически выводить разные подписи на OSD. Например, `ALEXEY X`, `ALEXEY Y` и `ALEXEY Z`.

Каждый микроконтроллер STM32 имеет свой уникальный неизменяемый 96-битный идентификатор, зашитый в него на заводе. Его можно увидеть в CLI при выводе `dump` или `diff all` или командой `mcu_id`.<br>
Пример: `mcu_id 0047000e3030510939383634`

При помощи новой команды `uid` можно добавить таблицу, где указывается, какая подпись в OSD должна соответствовать каждому mcu_id. 

```
uid 0 003b001b3538510e34393631 W
uid 1 0023002f3438510831353632 X
uid 2 002c00303538510e34393631 Y
uid 3 0051003a3538510835343631 Z

name Alexey
save
```

В результате при вводе одной и той же таблицы в CLI во все дроны, на каждом будет показываться разное имя пилота: у дрона с идентификатором `0051003...` будет выводиться `ALEXEY Z`, для дрона `002c003...` - `ALEXEY Y` и т.д.
   
## Установка

1. Скачать HEX-файл для своего микроконтроллера F411/F405/F72X2 со страницы [Releases](https://github.com/alexeystn/betaflight/releases/).
2. В конфигураторе на странице перепрошивки через `Load Firmware [Local]` выбрать скачанный hex.
3. В меню `Choose a Board...` выбрать название своего контроллера. _Обязательно!_
4. Нажать `Flash Firware` и дождаться окончания загрузки.
5. Подключиться `Connect` после успешной прошивки и нажать `Appy Custom Defaults`, когда появится окно с предложением это сделать.
6. Восстановить в конфигураторе свои привычные настройки, которые вы используете в 4.3 и настроить новые функции.


## Контакты

По вопросам работы данной версии пишите мне в Телеграм: [@AlexeyStn](https://t.me/AlexeyStn)
